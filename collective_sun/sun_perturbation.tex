\documentclass[nofootinbib,notitlepage,11pt]{revtex4-2}

%%% linking references
\usepackage{hyperref}
\hypersetup{
  breaklinks=true,
  colorlinks=true,
  linkcolor=blue,
  filecolor=magenta,
  urlcolor=cyan,
}

%%% header / footer
\usepackage{fancyhdr} % easier header and footer management
\pagestyle{fancy} % page formatting style
\fancyhf{} % clear all header and footer text
\renewcommand{\headrulewidth}{0pt} % remove horizontal line in header
\usepackage{lastpage} % for referencing last page
\cfoot{\thepage~of \pageref{LastPage}} % "x of y" page labeling

%%% symbols, notations, etc.
\usepackage{physics,braket,bm,amssymb} % physics and math
\renewcommand{\t}{\text} % text in math mode
\newcommand{\f}[2]{\dfrac{#1}{#2}} % shorthand for fractions
\newcommand{\p}[1]{\left(#1\right)} % parenthesis
\renewcommand{\sp}[1]{\left[#1\right]} % square parenthesis
\renewcommand{\set}[1]{\left\{#1\right\}} % curly parenthesis
\newcommand{\bk}{\Braket} % shorthand for braket notation

\renewcommand{\c}{\cdot} % inner product

\newcommand{\m}{\bm} % bold symbol
\renewcommand{\v}{\vec} % arrow vector

\usepackage{dsfont} % for identity operator
\newcommand{\1}{\mathds{1}}

\newcommand{\up}{\uparrow}
\newcommand{\dn}{\downarrow}

\renewcommand{\d}{\text{d}}
\newcommand{\x}{\text{x}}
\newcommand{\y}{\text{y}}
\newcommand{\z}{\text{z}}

\newcommand{\A}{\mathcal{A}}
\newcommand{\B}{\mathcal{B}}
\newcommand{\C}{\mathcal{C}}
\newcommand{\E}{\mathcal{E}}
\newcommand{\G}{\mathcal{G}}
\newcommand{\I}{\mathcal{I}}
\newcommand{\M}{\mathcal{M}}
\newcommand{\N}{\mathcal{N}}
\renewcommand{\P}{\mathcal{P}}
\renewcommand{\S}{\mathcal{S}}
\newcommand{\T}{\mathcal{T}}
\newcommand{\Z}{\mathcal{Z}}

\newcommand{\PP}{\mathbb{P}}
\renewcommand{\SS}{\mathbb{S}}
\newcommand{\TT}{\mathbb{T}}
\newcommand{\ZZ}{\mathbb{Z}}

\newcommand{\PS}{\text{PS}}
\newcommand{\EQPS}{=_{\text{PS}}}
\newcommand{\col}{\underline}

\let\var\relax
\DeclareMathOperator{\var}{var}
\DeclareMathOperator{\diag}{diag}
\newcommand{\ul}{\underline}

\usepackage{accents} % for the undertilde
\newcommand{\ut}{\undertilde}

\newcommand{\floor}[1]{\lfloor{#1}\rfloor}
\newcommand{\ceil}[1]{\lceil{#1}\rceil}

\def\obra#1{\mathinner{({#1}|}}
\def\oket#1{\mathinner{|{#1})}}
\def\obk#1{\mathinner{({#1})}}
\def\oop#1#2{\oket{#1}\!\obra{#2}}

\usepackage{mathtools} % for coloneqq

\usepackage[inline]{enumitem} % in-line lists and \setlist{} (below)
\setlist[enumerate,1]{label={(\roman*)}} % default in-line numbering
\setlist{nolistsep} % more compact spacing between environments

%%% figures
\usepackage{graphicx} % for figures
\graphicspath{{./figures/}} % set path for all figures
\usepackage[export]{adjustbox} % for vertical alignment in math
\newcommand{\diagram}[1]
{\,\includegraphics[valign=c]{diagrams/#1.pdf}\,}

% alphanumeric footnotes
\renewcommand*{\thefootnote}{\alph{footnote}}

%%% text markup
\usepackage{color} % text color
\newcommand{\red}[1]{{\color{red} #1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{SU($n$) spin models near the Heisenberg critical point}%
\author{Michael A. Perlin}%
\date{\today}

\maketitle

\tableofcontents

\section{Introduction}

\red{TODO: write an introduction}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The SU($n$) Heisenberg model}

We consider an array of $N$ multilevel spins with SU($n$)-symmetric
interactions that can be written in the form
\begin{align}
  H_0 = \sum_{\p{p,q}\in\C_N\p{2}} h_{pq} \Pi_{pq},
  &&
  \Pi_{pq} \equiv \sum_{\mu,\nu\in\ZZ_n} s_{\mu\nu}^{(p)} s_{\nu\mu}^{(q)},
  \label{eq:H_0}
\end{align}
where $p,q$ index individual spins; $\C_N\p{M}$ is the set of all
choices of $M$ spins out of $N$; $h_{pq}$ are scalar coupling
constants; $\mu,\nu$ index states in an orthonormal basis for the
$n$-dimensional Hilbert space of a single spin; $\ZZ_N$ is the set of
integers modulo $N$; the operator
$s_{\mu\nu}^{(p)}\equiv\op{\mu}{\nu}_p$ flips the state of spin $p$ to
$\ket\mu$ from $\ket\nu$; and the operator $\Pi_{pq}$ permutes the
states of spins $p$ and $q$.  The permutation operator $\Pi_{pq}$ is
essentially a multilevel generalization of the SU(2)-symmetric spin
interaction $\v s_p\c\v s_q$, with $\v s\equiv\p{\v s_\x,s_\y,s_\z}$,
$s_\alpha\equiv\sigma_\alpha/2$, and $\sigma_\alpha$ a single-spin
Pauli operator.

If the coefficients $h_{pq}$ of the interaction Hamiltonian $H_0$ are
all negative, then the ground-state manifold $\M_0$ of the interaction
Hamiltonian $H_0$ consists of permutationally symmetric (PS) states
that are simultaneous $+1$ eigenstates of all permutation operators
$\Pi_{pq}$.  We will assume that all $h_{pq}<0$ throughout these
notes, but comment that this restriction can be relaxed to the
assumption that the initial state of all spins is permutationally
symmetric (e.g.~a spin-polarized state).  We will also assume that the
PS manifold $\M_0$ is gapped away from all orthogonal states by an
interaction energy $\Delta_{\t{gap}}>0$.  Power-law couplings of the
form $h_{pq}\sim-1/\abs{p-q}^\alpha$ on a $D$-dimensional lattice, for
example, always yield a non-vanishing spectral gap $\Delta_{\t{gap}}$
for long-range interactions with $\alpha\le D$ (see Appendix
\ref{sec:spectral_gap}).

The PS manifold $\M_0$ is spanned by a basis of states
$\ket{m}=\ket{m_1,m_2,\cdots,m_n}$ with a definite occupation number
$m_\mu$ of the single-spin state $\mu$, and $\sum_\mu m_\mu=N$.  In
the case of $n=2$, for example, the PS manifold $\M_0$ is precisely
the Dicke manifold\cite{dicke1954coherence} of $N$ qubits, spanned by
Dicke states $\set{\ket{m_0,m_1}}$ for which $m_0+m_1=N$ and the
integer $m_0$ ($m_1$) indicates the total occupation number of qubit
state $\ket{0}$ ($\ket{1}$).  The dimension of the PS manifold $\M_0$
is determined by the number of ways to assign $N$ spins to $n$ states,
which is ${N+n-1 \choose n-1}\sim N^{n-1}$.  The energy of any PS
state $\ket\psi\in\M_0$ with respect to the interaction Hamiltonian
$H_0$ in \eqref{eq:H_0} is
\begin{align}
  E_0 = \sum_{\p{p,q}\in\C_N\p{2}} h_{pq}.
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Breaking SU($n$) symmetry (perturbatively)}
\label{eq:pert_theory}

In order to induce non-trivial dynamics for initially PS states
$\ket\psi\in\M_0$, which are otherwise stationary eigenstates of the
interaction Hamiltonian $H_0$ in \eqref{eq:H_0}, we will add to the
Hamiltonian an operator of the general form \red{[TODO: consider more
  general sums of such operators]}
\begin{align}
  X_{\m w} \equiv \sum_{k\in\C_N\p{M}} w_k X_k,
  \label{eq:pert}
\end{align}
where $X$ is an $M$-spin operator that is invariant under arbitrary
permutation of its tensor factors; $k\equiv\p{k_1,k_2,\cdots,k_M}$ is
a choice of $M$ distinct spins that $X_k$ acts on; $\C_N\p{M}$ is the
set of all choices of $M$ elements from a set of size $N$; and $\m w$
is a dimension-$M$ tensor with scalar entries $w_k$.  Even though only
${N\choose M}$ entries of $\m w$ are used to define $X_{\m w}$ in
\eqref{eq:pert}, for later convenience we define $w_k$ for all indices
$k\in\ZZ_N^M$ by enforcing that $\m w$ is symmetric with respect to
any permutation of its indices, and that $w_k=0$ for any $k$ with
repeated values. \red{[TODO: relax the restrictions on $X$ and $\m w$
  to allow for more general perturbations, e.g.~of the form
  $s_\x\otimes s_\y-s_\y\otimes s_\x$]}

Single-body ($M=1$) operators correspond to classical external fields,
e.g.~$s_\z$ for a magnetic field, and two-body ($M=2$) operators
correspond to two-body interactions that deviate from $H_0$, such as
$s_\z\otimes s_\z$ interactions in an XXZ model\red{[TODO:cite]} near
the Heisenberg critical point.  While we would be hard-pressed to find
a physical implementation of multi-body spin interactions with $M>2$,
considering this case will be necessary to construct low-lying
eigenstates of $H_0$.  Constructing low-lying eigenstates of $H_0$
will in turn enable simulating the dynamics induced by
non-perturbative additions $X_{\m w}$ to the SU($n$) Heisenberg model,
with norms $\norm{X_{\m w}}\sim\Delta_{\t{gap}}$.

When $X_{\m w}$ is sufficiently small, we can treat its effect on the
PS manifold $\M_0$ perturbatively.  The effective Hamiltonian
$H_{\t{eff}}$ induced by $X_{\m w}$ on the ground-state manifold
$\M_0$ through second order in perturbation theory
is\cite{bravyi2011schrieffer, perlin2019effective}
\begin{align}
  H_{\t{eff}} = H_{\t{eff}}^{(1)} + H_{\t{eff}}^{(2)},
  &&
  H_{\t{eff}}^{(1)} = \P_0 X_{\m w} \P_0,
  &&
  H_{\t{eff}}^{(2)} = - \sum_{\Delta\ne0}
  \f1\Delta \P_0 X_{\m w} \P_\Delta X_{\m w} \P_0,
  \label{eq:H_eff}
\end{align}
where $\P_\Delta$ is a projector onto the eigenspace $\E_\Delta$ of
the interaction Hamiltonian $H_0$ with interaction energy $\Delta$
above that of PS manifold $\M_0$.  In particular, $\P_0$ is a
projector onto $\M_0$ itself, and $\E_0=\M_0$.  The first order
effective Hamiltonian $H_{\t{eff}}^{(1)}$ is straightforward to
simplify using the permutational symmetry of $\M_0$:
\begin{align}
  H_{\t{eff}}^{(1)} \EQPS \bar w\,\col{X},
  \label{eq:H_eff_1}
\end{align}
where $\EQPS$ denotes equality under a restriction to $\M_0$; $\bar w$
is an average of $w_k$ over spin choices $k\in\C_N\p{M}$; and
$\col{X}$ is the collective version of $X$, i.e.
\begin{align}
  \bar w \equiv { N \choose M }^{-1} \sum_{k\in\C_N\p{M}} w_k,
  &&
  \col{X} \equiv \sum_{k\in\C_N\p{M}} X_k,
\end{align}
An immediate consequence of \eqref{eq:H_eff_1} is the fact that
perturbing SU(2)-symmetric interactions by two-body $s_\z\otimes s_\z$
interactions yields the one-axis twisting (OAT)
Hamiltonian\cite{kitagawa1993squeezed, ma2011quantum}
$H_{\t{OAT}}=\chi S_\z^2$ at first order in perturbation theory, with
the OAT strength $\chi$ equal to the mean coefficient of the two-body
$s_\z\otimes s_\z$ terms.

The second order effective Hamiltonian $H_{\t{eff}}^{(2)}$ is not as
straightforward to simplify due to the presence of a projector
$\P_\Delta$ onto the manifold $\E_\Delta$ of states with excitation
energy $\Delta$ (with respect to $H_0$).  This projector essentially
picks off the part of $X_{\m w}$ that is strictly off-diagonal with
respect to the ground- and excited-state manifolds $\E_0$ and
$\E_\Delta$.  To decompose $X_{\m w}$ into components that generate
states of definite excitation energy when acting on PS states $\M_0$,
we pick an arbitrary state $\ket\psi\in\M_0$ and expand (see Appendix
\ref{sec:eigenstates})
\begin{align}
  H_0 X_{\m w} \ket\psi
  = E_0 X_{\m w} \ket\psi + X_{\hat{\m h}\p{\m w}} \ket\psi,
  \label{eq:diagnosis}
\end{align}
where $\hat{\m h}$ is a linear map on the space of dimension-$M$
tensors, determined entirely by the couplings $h_{pq}$ of the
interaction Hamiltonian $H_0$.  The image $\hat{\m h}\p{\m w}$ of
$\m w$ under $\hat{\m h}$ is then itself a dimension-$M$ tensor that
defines the $M$-body operator $X_{\hat{\m h}\p{\m w}}$.  To write out
$\hat{\m h}\p{\m w}$ explicitly, we first define a matrix
$\m h\equiv\sum_{p,q\in\ZZ_N} h_{pq} \op{p}{q}$ of all couplings in
$H_0$ by enforcing that $h_{pq}=h_{qp}$ and $h_{pp}=0$.  We denote a
contraction of $\m h$ with the $a$-th index of $\m w$ by
$\m h \circ_a\m w$, such that the $k$-th entry of $\m h \circ_a\m w$
is
\begin{align}
  \p{\m h \circ_a \m w}_k
  = \sum_{p\in\ZZ_N\setminus k} h_{k_a p} w_{k_{a:p}},
\end{align}
where $k\equiv\p{k_1,k_2,\cdots,k_M}$ is a list of indices;
$k_{a:p}\equiv\p{k_1,k_2,\cdots,k_{a-1},p,k_{a+1},\cdots,k_M}$ is the
same list $k$, but with the $a$-th index $k_a$ replaced by $p$; and we
explicitly exclude terms with $p\in k$ that vanish due to the fact
that $\m h$ and $\m w$ are strictly off-diagonal.  We then define a
dimension-$M$ tensor $\tilde{\m h}$ with entries
\begin{align}
  \tilde h_k \equiv \sum_{\substack{p\in k\\q\in\ZZ_N\setminus k}} h_{pq}
\end{align}
for all $k\in\ZZ_N^M$, and we denote an element-wise (Kronecker)
product of $\tilde{\m h}$ and $\m w$ by $\tilde{\m h} * \m w$, with
entries $\tilde h_k w_k$.  These definitions allow us to expand
\begin{align}
  \hat{\m h}\p{\m w}
  \equiv \sum_{a\in\ZZ_M} \m h \circ_a \m w - \tilde{\m h} * \m w.
  \label{eq:multi_body_eig_op}
\end{align}
Viewed an operator on the vector space of dimension-$M$ tensors, the
map $\hat{\m h}$ is real and symmetric under transposition, and is
therefore diagonalizable.  Diagonalizing this operator yields
eigenvalues $\Delta$ and eigenvectors $\m m_\Delta$ for which
$\hat{\m h}\p{\m m_\Delta}=\Delta\m m_\Delta$.  Finding eigenvalues
and eigenvectors of $\hat{\m h}$ nominally requires diagonalizing a
matrix of dimensions
${N\choose M}\times{N\choose M}\sim N^M\times N^M$, but spatial
symmetries of $H_0$ such as translational invariance or isotropy can
drastically reduce the complexity of this eigenvalue problem.  We
discuss this reduction in Appendix \ref{sec:symmetries}.

Defining $\m w_\Delta$ as the projection of the tensor $\m w$ onto the
$\Delta$-eigenspace of $\hat{\m h}$, we can expand
\begin{align}
  \m w = \sum_\Delta \m w_\Delta,
  &&
  \hat{\m h}\p{\m w} = \sum_\Delta \Delta \m w_\Delta,
\end{align}
and in turn
\begin{align}
  X_{\m w} = \sum_\Delta X_{\m w_\Delta},
  &&
  X_{\hat{\m h}\p{\m w}} = \sum_\Delta \Delta X_{\m w_\Delta}.
\end{align}
Substituting these expansions into \eqref{eq:diagnosis}, we find
\begin{align}
  H_0 X_{\m w} \ket\psi
  = \sum_\Delta\p{E_0 + \Delta} X_{\m w_\Delta} \ket\psi,
\end{align}
which implies that the action of $X_{\m w_\Delta}$ on a PS state
$\ket\psi\in\M_0$ generates a state of definite interaction energy
$E_0+\Delta$.  It follows that
$\P_\Delta X_{\m w} \P_0 = \P_\Delta X_{\m w_\Delta} \P_0 = X_{\m
  w_\Delta} \P_0$, and so
\begin{align}
  H_{\t{eff}}^{(2)} = -\sum_{\Delta\ne0}
  \f1\Delta \P_0 X_{\m w_\Delta} X_{\m w_\Delta} \P_0.
\end{align}
The product $\P_0 X_{\m w_\Delta} X_{\m w_\Delta} \P_0$ generally
includes $r$-body operators for all positive integers $r\le2M$.  We
provide a general prescription for simplifying such products in
Appendix \ref{sec:operator_product}, and explicitly work out the
single-body ($M=1$) and two-body ($M=2$) cases in Appendices
\ref{sec:single_pair_prod} and \ref{sec:two_pair_prod}.  If $X$ is a
single-body operator ($M=1$), then
\begin{align}
  H_{\t{eff}}^{(2)}
  = \sum_{\Delta\ne0} \f{\var\p{\m w_\Delta}}{\p{N-1}\Delta}
  \p{\col{X}^2 - N \col{X^2}},
  &&
  \var\p{\m m} \equiv \f1N \sum_{p\in\ZZ_N} \p{m_p-\bar m}^2,
\end{align}
which in the SU(2) case implies that an inhomogeneous magnetic field
($X\propto\sigma_\z$) yields an OAT Hamiltonian at second order
perturbation theory.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Beyond ground-state perturbation theory}
\label{eq:excited_states}

In order to find the effective Hamiltonian $H_{\t{eff}}^{(2)}$ induced
by the $M$-body operator $X_{\m w}$ on the PS manifold $\M_0$ at
second order in perturbation theory, we constructed states with
definite excitation energy $\Delta$ with respect to $H_0$.  These
states are generated by the action of an $M$-body operator
$X_{\m w_\Delta}$ on a PS state $\ket\psi\in\M_0$.  We denote the
manifold of all states that can be generated by the action of some
$M$-body operator, but not any $r$-body operator with $r<M$, by
$\M_M$; we will refer to $\M_M$ as the $M$-body excitation manifold.
We then denote the a direct sum of all $\M_r$ for $r\le M$ by
$\ul{\M}_M$, i.e.~$\ul{\M}_M\equiv\bigoplus_{r\le M}\M_r$.  The
manifold $\ul{\M}_M$ consists of all states accessible by the action
of $r$-body operators with $r\le M$ on PS states in $\M_0$.

By construction, the $M$-body operator $X_{\m w}$ generally couples PS
states in $\M_0$ to asymmetric states in $\ul{\M}_M\setminus\M_0$.  If
the coupling between $\M_0$ and its complement is weak compared to the
spectral gap $\Delta_{\t{gap}}$ of $H_0$, then we can treat the effect
of $X_{\m w}$ perturbatively and derive an effective Hamiltonian
$H_{\t{eff}}$ on $\M_0$.  This ground-state perturbation theory
formally breaks down when the operator norm
$\norm{X_{\m w}}\ge\Delta_{\t{gap}}/2$, in which case the operator
$X_{\m w}$ first couples $\M_0$ to $\ul{\M}_M$, then $\ul{\M}_M$ to
$\ul{\M}_{2M}$, and so on.  Even if
$\norm{X_{\m w}}>\Delta_{\t{gap}}/2$, however, the energetic penalty
incurred by $H_0$ from breaking the permutational symmetry of an
initial state $\ket\psi\in\M_0$ suppresses the leakage of population
into manifolds $\M_r$ of increasing $r$.  One might therefore capture
the dynamics of an initial PS state $\ket\psi\in\M_0$ by projecting
$X_{\m w}$ onto $\ul{\M}_{r_{\t{max}}}$ for some $r_{\t{max}}\ge M$,
resulting in a theory analogous to first-order perturbation theory on
$\ul{\M}_{r_{\t{max}}}$.  In the perturbative regime
$\norm{X_{\m w}}<\Delta_{\t{gap}}/2$, such a theory captures all
virtual processes through order $2\floor{r_{\t{max}}/M}+1$ in a formal
perturbation theory on $\M_0$.  In the non-perturbative regime
$\norm{X_{\m w}}\ge\Delta_{\t{gap}}/2$, the error incurred by
truncating the Hilbert space of a spin system past
$\ul{\M}_{r_{\t{max}}}$ is not clear a priori.  Nonetheless,
simulations restricted to $\ul{\M}_{r_{\t{max}}}$ can be benchmarked
by examining the maximum populations within all $\M_r$ for
$r\le r_{\t{max}}$ throughout simulation.  As long as
\begin{enumerate*}
\item these
populations fall off with increasing $r$,
\item and the maximal population within large-$r$ manifolds $\M_r$ is
  small,
\end{enumerate*}
one should expect such simulations to faithfully capture (at least
qualitatively) the dynamical behavior of the spin system under
consideration.

In order to project an operator $X_{\m w}$ onto
$\ul{\M}_{r_{\t{max}}}$, we first need to construct a basis for
$\ul{\M}_{r_{\t{max}}}$, and then compute all matrix elements of
$X_{\m w}$ in the constructed basis.  Our strategy will be to first
identify a basis for $\M_0$, and then find, for each
$r=1,\cdots,r_{\t{max}}$, a suitable set of $r$-body operators
$\set{O}$ and dimension-$r$ tensors $\set{\m u}$ for which the states
$\ket{O,\m u,m}\propto O_{\m u}\ket{m}$ form an orthonormal basis for
$\M_r$.  Matrix elements of $X_{\m w}$ with respect to this basis for
$\ul{\M}_{r_{\t{max}}}$ then take the form
\begin{align}
  \bk{O,\m u,\ell|X_{\m w}|Q,\m v,m}
  = \f{\bk{\ell|O_{\m u}^\dag X_{\m w} Q_{\m v}|m}}
  {\sqrt{\bk{\ell|O_{\m u}^\dag O_{\m u}|\ell}
      \bk{m|Q_{\m v}^\dag Q_{\m v}|m}}}.
\end{align}
In order to compute these matrix elements, we simplify products of the
form $\P_0 O_{\m u}^\dag X_{\m w} Q_{\m v} \P_0$ and
$\P_0 O_{\m u}^\dag O_{\m u} \P_0$, with $\P_0$ a projector onto
$\M_0$, in Appendix \ref{sec:operator_product}.

A suitable basis for $\M_0$ is the set of PS states
$\ket{m}=\ket{m_1,m_2,\cdots,m_n}$ with a definite occupation number
$m_\mu$ of the single-spin state $\mu$.


\red{[TODO: finish section]}



\newpage
\appendix

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Existence of a spectral gap with long-range power-law
  interactions}
\label{sec:spectral_gap}

Here we show that power-law SU($n$)-symmetric interactions of the form
in \eqref{eq:H_0} with $h_{pq}=-h/\abs{p-q}^\alpha$ yield a
non-vanishing many-body interaction energy gap when $\alpha\le D$,
where $D$ is the dimension of the lattice.  On a periodic lattice of
$N=L^D$ spins, the spectral gap of the interaction Hamiltonian is (see
Appendix \ref{sec:single_body_eigenstates})
\begin{align}
  \Delta
  = \sum_{d\in\ZZ_L^D} h_{0,d} \sp{\cos\p{d \c k_{\t{SE}}}-1}
  = h \sum_{\substack{d\in\ZZ_L^D\\\abs{d}\ge1}}
  \f{1-\cos\p{d \c k_{\t{SE}}}}{\abs{d}^\alpha},
\end{align}
where the domain of $d$ is defined in terms of integers modulo $L$,
i.e.~$\ZZ_L\simeq\set{0,1,\cdots,L-1}$ with the relation $\simeq$
denoting an association that ignores the cyclic structure of $\ZZ_L$;
$k_{\t{SE}}\in\ZZ_L^D\times2\pi/L$ is a wavenumber for a
singly-excited spin-wave state; and the norm $\abs{d}$ for a vector
$d$ on a periodic lattice is implicitly understood to mean the
smallest Euclidean distance of $d$ from a fixed origin.  In order to
yield the smallest excitation energy $\Delta$, the wavenumber
$k_{\t{SE}}$ should maximize the contribution of the cosine term
above, which is achieved by a wavenumber that minimizes the
oscillations of this term when integrated over the entire lattice.  A
suitable candidate for a minimal wavenumber is
$k_{\t{SE}}=\p{2\pi/L,0,0,\cdots}$, which corresponds to an excitation
energy
\begin{align}
  \Delta = h \sum_{\substack{d\in\ZZ_L^D\\\abs{d}\ge1}}
  \f{1-\cos\p{d_12\pi/L}}{\abs{d}^\alpha}.
\end{align}
Defining $\epsilon\equiv2/L$ and a rescaled domain symmetrized about
$0$, $\SS_\epsilon\simeq\ZZ_L/\epsilon$ with
$\SS_\epsilon\subset\sp{-1,1}$, we substitute $x\simeq\epsilon d$ to
get
\begin{align}
  \Delta
  = h \sum_{\substack{x\in\SS_\epsilon^D\\\abs{x}\ge\epsilon}}
  \f{1-\cos\p{\pi x_1}}{\abs{x/\epsilon}^\alpha}
  = h \epsilon^{\alpha-D} \sum_{\substack{x\in\SS_L^D\\\abs{x}\ge\epsilon}}
  \epsilon^D \f{1-\cos\p{\pi x_1}}{\abs{x}^\alpha}.
\end{align}
As $\epsilon\to0$ the discrete sum over $x$ is well approximated by an
integral that avoids an infinitesimal region about the origin, i.e.
\begin{align}
  \Delta = h \epsilon^{\alpha-D} \I_{D\epsilon},
  &&
  \I_{D\epsilon}
  \equiv \int_{\TT_1^D\setminus\TT_\epsilon^D} \d^Dx\,
  \f{1-\cos\p{\pi x_1}}{\abs{x}^\alpha},
\end{align}
where the integral $\I_{D\epsilon}$ is defined using the interval
$\TT_a\equiv\p{-a,a}$.  The integrand of $\I_{D\epsilon}$ is strictly
positive and well-behaved on the entirety of its domain except for the
origin, where depending on the value of $\alpha$ the integrand may
vanish or diverge as $\abs{x}\to0$.  Together, these facts mean that
\begin{align}
  \I_{D\epsilon} \stackrel{\epsilon\to0}{\sim} \epsilon^{-\gamma},
  &&
  \Delta \stackrel{\epsilon\to0}{\sim} h \epsilon^{\alpha-D-\gamma},
\end{align}
for some $\gamma\ge0$, which implies that gap $\Delta$ is
non-vanishing when $\alpha\le D\le D+\gamma$.

For the sake of completion, we add that in fact the gap $\Delta$
always vanishes in the thermodynamic limit when $\alpha>D$.  To see
this behavior, we note that the asymptotic dependence of the integral
$I_{D\epsilon}$ on $\epsilon$ is determined by the behavior of its
integrand when $\abs{x}\sim\epsilon$, in which case
$1-\cos\p{\pi x_1}\sim x_1^2$, so
\begin{align}
  \I_{D\epsilon}
  \sim \int_{\TT_1^D\setminus\TT_\epsilon^D} \d^Dx\,
  \f{x_1^2}{\abs{x}^\alpha}.
\end{align}
We can then use the fact that $x_1^2\le\abs{x}^2$ and change to
spherical coordinates to find that
\begin{align}
  \I_{D\epsilon} \lesssim
  \int_{\TT_1^D\setminus\TT_\epsilon^D} \d^Dx\,
  \f{\abs{x}^2}{\abs{x}^\alpha}
  \sim \int_\epsilon^1 \d x\, x^{D+1-\alpha}
  \sim
  \begin{cases}
    \epsilon^0 & \alpha < D+2 \\
    \log\p{1/\epsilon} & \alpha = D+2 \\
    \epsilon^{D+2-\alpha} & \alpha > D+2
  \end{cases}.
\end{align}
It follows that the spectral gap
\begin{align}
  \Delta \stackrel{\epsilon\to0}{\lesssim}
  \begin{cases}
    \epsilon^{\alpha-D} & \alpha < D+2 \\
    \epsilon^2 \log\p{1/\epsilon} & \alpha = D + 2 \\
    \epsilon^2 & \alpha > D+2
  \end{cases},
\end{align}
which vanishes as $\epsilon\to0$ for all $\alpha>D$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Constructing excitation energy eigenstates}
\label{sec:eigenstates}

In this section, we simplify the products of the form
$H_0X_{\m w}\ket\psi$ to arrive at the expansion in
\eqref{eq:diagnosis}, which defines conditions under which a
multi-body perturbation $X_{\m w_\Delta}$ generates eigenstates of the
SU($n$)-symmetric interaction Hamiltonian $H_0$ in \eqref{eq:H_0} when
acting on a permutationally symmetric state $\ket\psi\in\M_0$.  Here
$X_{\m w}$ is an $M$-body perturbation defined by
\begin{align}
  X_{\m w} \equiv \sum_{k\in\C_N\p{M}} w_k X_k,
  \label{eq:pert_copy}
\end{align}
where $X$ is an $M$-spin operator that is invariant under arbitrary
permutation of its tensor factors; $k\equiv\p{k_1,k_2,\cdots,k_M}$ is
a choice of $M$ distinct spins that $X_k$ acts on; $\C_N\p{M}$ is the
set of all choices of $M$ elements from a set of size $N$; and $\m w$
is a dimension-$M$ tensor with scalar entries $w_k$.  Even though only
${N\choose M}$ entries of $\m w$ are used to define $X_{\m w}$ in
\eqref{eq:pert_copy}, for later convenience we define $w_k$ for all
indices $k\in\ZZ_N^M$ by enforcing that $\m w$ is symmetric with
respect to any permutation of its indices, and that $w_k=0$ for any
$k$ with repeated values. \red{[TODO: relax the restrictions on $X$
  and $\m w$ to allow for more general perturbations, e.g.~of the form
  $s_\x\otimes s_\y-s_\y\otimes s_\x$]}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Single-body excitations}
\label{sec:single_body_eigenstates}

In order to build familiarity with the problem at hand, we first
consider the simple case of a single-body perturbation and simplify
\begin{align}
  H_0 X_{\m w} \ket\psi
  = \sum_{\substack{\p{p,q}\in\C_N\p{2}\\k\in\ZZ_N}}
  h_{pq} w_k \Pi_{pq} X_k \ket\psi.
  \label{eq:single_body_diagnosis_start}
\end{align}
The sum in \eqref{eq:single_body_diagnosis_start} has terms with
$k\in\set{p,q}$, and terms with $k\notin\set{p,q}$.  In the case of
$k\notin\set{p,q}$, the permutation operator $\Pi_{pq}$ commutes with
$X_k$ and annihilates on $\ket\psi$, leaving terms at each fixed $k$
of the form
\begin{align}
  \sum_{\substack{\p{p,q}\in\C_N\p{2}\\k\notin\set{p,q}}} h_{pq}
  = \sum_{\p{p,q}\in\C_N\p{2}} h_{pq}
  - \sum_{\substack{\p{p,q}\in\C_N\p{2}\\k\in\set{p,q}}} h_{pq}
  = E_0 - \f12 \sum_{\substack{p,q\in\ZZ_N\\k\in\set{p,q}}} h_{pq}
  = E_0 - h_k,
\end{align}
where we define $h_{pq}$ for arbitrary $p,q$ by enforcing
$h_{pq}=h_{qp}$ and $h_{pp}=0$; and $h_k \equiv \sum_\ell h_{k\ell}$.
The terms in \eqref{eq:single_body_diagnosis_start} with
$k\notin\set{p,q}$ are then
\begin{align}
  \sum_{\substack{\p{p,q}\in\C_N\p{2}\\k\notin\set{p,q}}}
  h_{pq} w_k \Pi_{pq} X_k \ket\psi
  = \sum_{k\in\ZZ_N} \p{E_0 - h_k} w_k X_k \ket\psi
  = E_0 X_{\m w} \ket\psi - \sum_{k\in\ZZ_N} h_k w_k X_k \ket\psi
\end{align}
while the terms in \eqref{eq:single_body_diagnosis_start} with
$k\in\set{p,q}$ take the form
\begin{align}
  \sum_{\substack{\p{p,q}\in\C_N\p{2}\\k\in\set{p,q}}}
  h_{pq} v_k \Pi_{pq} X_k \ket\psi
  = \sum_{\p{k,q}\in\C_N\p{2}} h_{kq} w_k X_q \ket\psi
  + \sum_{\p{p,k}\in\C_N\p{2}} h_{pk} w_k X_p \ket\psi
  = \sum_{k,q\in\ZZ_N} h_{kq} w_k X_q \ket\psi
\end{align}
which implies
\begin{align}
  H_0 X_{\m w} \ket\psi
  = E_0 X_{\m w} \ket\psi
  + \sum_{p\in\ZZ_N} \p{\sum_{q\in\ZZ_N} h_{pq} w_q - h_p w_p}
  X_p \ket\psi.
  \label{eq:single_body_diagnosis_end}
\end{align}
The action of the single-body perturbation $X_{\m w}$ on a
permutationally symmetric state therefore generates an eigenstate of
$H_0$ with energy $E_0+\Delta$ if the vector
$\v{\m w}\equiv\sum_{k\in\ZZ_N} w_k \ket{k}$ satisfies the eigenvalue
equation
\begin{align}
  \p{\m h - \diag\v h} \c \v{\m w} = \Delta \v{\m w},
  \label{eq:single_body_eig}
\end{align}
where $\m h\equiv\sum_{p,q\in\ZZ_N} h_{pq} \op{p}{q}$ is a matrix of
all couplings $h_{pq}$; the vector
$\v h\equiv\sum_{p,q\in\ZZ_N} h_{pq} \ket{p}$ is the sum of all
columns of $\m h$; and $\diag\v h$ is a matrix with $\v h$ on the
diagonal and zeroes everywhere else.

When the interaction Hamiltonian $H_0$ is translationally invariant,
the single-body eigenvalue problem in \eqref{eq:single_body_eig} is
solvable analytically.  In this case, the couplings $h_{pq}$ depend
only on the separation $\abs{p-q}$, so the eigenvectors of $\m h$ are
plane waves of the form
\begin{align}
  \v{\m w}_k \equiv \sum_{p\in\ZZ_L^D} e^{ip\c k} \ket{p},
\end{align}
where on a $D$-dimensional periodic lattice of $N=L^D$ spins, lattice
sites are indexed by vectors $p\in\ZZ_L^D$, and wavenumbers take on
values $k\in\ZZ_L^D\times2\pi/L$.  The corresponding eigenvalues of
$\m h$ can be determined by expanding
\begin{align}
  \m h\c{\m w}_k
  = \sum_{p,q\in\ZZ_L^D} h_{pq} e^{iq\c k} \ket{p}
  = \sum_{p,d\in\ZZ_L^D} h_{p,p+d} e^{i\p{p+d}\c k} \ket{p}
  = \sum_{d\in\ZZ_L^D} h_{0,d} e^{id\c k} \v{\m w}_k
  = \sum_{d\in\ZZ_L^D} h_{0,d} \cos\p{d\c k} \v{\m w}_k,
\end{align}
where the imaginary terms vanish because $h_{0,d}=h_{0,-d}$.  The
remainder of \eqref{eq:single_body_eig} that we need to sort out is
$\diag\v h$, where all
$h_p=\sum_{q\in\ZZ_L^D}h_{pq}=\sum_{d\in\ZZ_L^D}h_{0,d}$ are equal,
which implies that $\diag\v h=\sum_{d\in\ZZ_L^D}h_{0,d}$ is a scalar.
We thus find that
\begin{align}
  \p{\m h - \diag\v h}\c\v v_k = \Delta_k \v{\m w}_k,
  &&
  \Delta_k \equiv \sum_{d\in\ZZ_L^D} h_{0,d} \sp{\cos\p{d\c k}-1}.
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Multi-body excitations}
\label{sec:multi_body_eigenstates}

We now consider the full $M$-body case
\begin{align}
  H_0 X_{\m w} \ket\psi
  = \sum_{\substack{\p{p,q}\in\C_N\p{2}\\k\in\C_N\p{M}}}
  h_{pq} w_k \Pi_{pq} X_k \ket\psi.
  \label{eq:diagnosis_start}
\end{align}
The sum in \eqref{eq:diagnosis_start} has terms with $p,q\in k$, terms
with $p,q\notin k$, and terms with only one of $p$ or $q\in k$.  The
permutation operator $\Pi_{pq}$ acts trivially on $X_k\ket\psi$ when
$p,q\in k$ or $p,q\notin k$, leaving terms at each fixed $k$ of the
form
\begin{align}
  \sum_{\substack{\p{p,q}\in\C_N\p{2}\\p,q\in k~\t{or}~p,q\notin k}} h_{pq}
  = \sum_{\p{p,q}\in\C_N\p{2}} h_{pq}
  - \sum_{\substack{p\in k\\q\notin k}} h_{pq}
  = E_0 - \tilde h_k,
  &&
  \tilde h_k \equiv \sum_{\substack{p\in k\\q\in\ZZ_N\setminus k}} h_{pq},
\end{align}
where we split a sum over $\p{p,q}\in\C_N\p{2}$ with the restriction
that $p,q\in k$ or $p,q\notin k$ into an unrestricted sum minus a
remainder with the complementary restriction.  The terms in
\eqref{eq:diagnosis_start} with $p,q\in k$ or $p,q\notin k$ are then
\begin{align}
  \sum_{k\in\C_N\p{M}} \p{E_0 - \tilde h_k} w_k X_k \ket\psi
  = E_0 X_{\m w} \ket\psi
  - \sum_{k\in\C_N\p{M}} \p{\tilde{\m h} * \m w}_k X_k \ket\psi,
\end{align}
where $\tilde{\m h}$ is a tensor with entries $\tilde h_k$; and
$\tilde{\m h} * \m w$ denotes an element-wise (Kronecker) product of
$\tilde{\m h}$ and $\m w$, with entries $\tilde h_k w_k$.  The
remaining terms in \eqref{eq:diagnosis_start} with only one of
$p\in k$ or $q\in k$ are
\begin{align}
  \sum_{k\in\C_N\p{M}} \sum_{\substack{p\in\ZZ_N\\p\notin k}} \sum_{q\in k}
  h_{pq} w_k \Pi_{pq} X_k \ket\psi
  = \sum_{k\in\C_N\p{M}} \sum_{\substack{p\in\ZZ_N\\p\notin k}}
  \sum_{a\in\ZZ_M} h_{p k_a} w_k \Pi_{p k_a} X_k \ket\psi.
\end{align}
where $k=\p{k_1,k_2,\cdots,k_M}$, with $k_a$ the $a$-th entry in $k$.
Defining $k_{a:p}$ to be a list that is equal to $k$ but with the
$a$-th number $k_a$ replaced by $p$,
$k_{a:p}\equiv\p{k_1,k_2,\cdots,k_{a-1},p,k_{a+1},\cdots,k_M}$, we can
simplify
\begin{align}
  \Pi_{p k_a} X_k \ket\psi
  = \Pi_{p k_a} X_k \Pi_{p k_a} \ket\psi
  = X_{k_{a:p}}\ket\psi,
\end{align}
and switch the labels for $p$ and $k_a$ to find that
\begin{align}
  \sum_{k\in\C_N\p{M}} \sum_{\substack{p\in\ZZ_N\\p\notin k}}
  \sum_{q\in k} h_{pq} w_k  \Pi_{pq} X_k \ket\psi
  = \sum_{k\in\C_N\p{M}} \sum_{\substack{p\in\ZZ_N\\p\notin k}}
  \sum_{a\in\ZZ_M} h_{pk_a} w_{k_{a:p}} X_k \ket\psi.
\end{align}
For each fixed $a$, the sum over $p$ above is essentially a
contraction of the matrix $\m h$ with the $a$-th index of the tensor
$\m w$.  Denoting such a contraction by $\m h\c_a\m w$, we can
therefore write this result as
\begin{align}
  \sum_{k\in\C_N\p{M}} \sum_{a\in\ZZ_M}
  \p{\m h \circ_a \m w}_k X_k \ket\psi,
\end{align}
where, for clarity, the matrix elements of $\m h\circ\m w$ are
\begin{align}
  \p{\m h \circ_a \m w}_k
  \equiv \sum_{\substack{p\in\ZZ_N\\p\notin k}} h_{pk_a} w_{k_{a:p}}
  = \sum_{\substack{p\in\ZZ_N\\p\notin k}}
  h_{pk_a} w_{k_1 k_2 \cdots k_{a-1} p k_{a+1} \cdots k_M}.
\end{align}
Altogether, we thus find that
\begin{align}
  H_0 X_{\m w} \ket\psi
  = E_0 X_{\m w} \ket\psi + \sum_{k\in\C_N\p{M}}
  \hat{\m h}\p{\m w}_k X_k \ket\psi,
  &&
  \hat{\m h}\p{\m w}
  \equiv \sum_{a\in\ZZ_M} \m h \circ_a \m w - \tilde{\m h} * \m w.
  \label{eq:diagnosis_end}
\end{align}
The action of the $M$-body perturbation $X_{\m w}$ on a
permutationally symmetric state therefore generates an eigenstate of
$H_0$ with energy $E_0+\Delta$ if the coefficient tensor $\m w$
satisfies the generalized eigenvalue equation
$\hat{\m h}\p{\m w} = \Delta \m w$, which can be written in the form
\begin{align}
  \hat{\m h} \c \v{\m w} = \Delta \v{\m w},
  \label{eq:multi_body_eig_mat}
\end{align}
where
\begin{align}
  \hat{\m h} \equiv \sum_{k\in\C_N\p{M}}
  \sum_{\substack{p\in\ZZ_N\\p\notin k}}
  \sum_{a\in\ZZ_M} h_{pk_a} \op{k}{k_{a:p}}
  - \sum_{k\in\C_N\p{M}} \tilde h_k \op{k},
  &&
  \v{\m w} \equiv \sum_{k\in\C_N\p{M}} w_k \ket{k}.
\end{align}
If $M=1$, then
$\p{\m h\circ\m w}_k=\sum_{\ell\in\ZZ_N} h_{k\ell} w_\ell$ and
$\tilde h_k = h_k \equiv \sum_{\ell\in\ZZ_N} h_{k\ell}$, so
\begin{align}
  H_0 X_{\m w} \ket\psi
  = E_0 X_{\m w} \ket\psi + \sum_{k\in\ZZ_N}
  \p{\sum_{\ell\in\ZZ_N} h_{k\ell} w_\ell - h_k w_k} X_k \ket\psi,
\end{align}
which is precisely what we found in
\eqref{eq:single_body_diagnosis_end}.  If $M=2$, then
$\p{\m h\circ\m w}_{pq} = \sum_{k\in\ZZ_N}
\p{h_{pk}w_{kq}+h_{qk}w_{pk}}$, so
\begin{align}
  H_0 X_{\m w} \ket\psi
  = E_0 X_{\m w} \ket\psi + \sum_{\p{p,q}\in\C_N\p{2}}
  \sp{\sum_{k\in\ZZ_N}\p{h_{pk} w_{kq} + h_{qk} w_{pk}}
    - \tilde h_{pq} w_{pq}}
  X_k \ket\psi,
\end{align}
where $\tilde h_{pq}=h_p+h_q-2h_{pq}$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Exploiting spatial symmetries}
\label{sec:symmetries}

Solving the eigenvalue problem in \eqref{eq:multi_body_eig_mat} to
find $M$-body perturbations $X_{\m w}$ that generate states of
definite interaction energy nominally requires diagonalizing the
matrix $\hat{\m h}$ with dimensions
${N\choose M}\times{N\choose M}\sim N^M\times N^M$.  If the
interaction Hamiltonian $H_0$ has any spatial symmetries, however,
then we can use these symmetries to reduce the complexity of this
eigenvalue problem.  Translational invariance, for example, can reduce
this problem to that of diagonalizing a matrix with dimensions
$\le{N-1\choose M-1}\times{N-1\choose M-1}\sim N^{M-1}\times N^{M-1}$,
and isotropy can further reduce the problem size by factors that
depend on the lattice geometry.  The complexity of diagonalizing a
matrix with dimensions $d\times d$ is $O\p{d^3}$, so even a reduction
of $d$ by a factor of 2 yields practically significant gains (a factor
of $2^3=8$) in the runtime of diagonalization.  Here, we provide a
general prescription for exploiting the spatial symmetries of $H_0$ to
simplify the eigenvalue problem in \eqref{eq:multi_body_eig_mat}.

Our task is essentially to express the multi-body eigenvalue problem
in \eqref{eq:multi_body_eig_mat} in a basis that respects the spatial
symmetries of $H_0$.  These symmetries essentially break the set of
choices $\C_N\p{M}$ into equivalence classes $\S_M$\footnote{For
  brevity, we will suppress the explicit dependence of $\S_M$ on $N$,
  as well as the dependence of $\S_M$ on any other factors such as
  lattice geometry.}, where elements $s\in\S_M$ are subsets
$s\subset\C_N\p{M}$ that are invariant under the appropriate symmetry
group action.  In the case of a translationally invariant and
isotropic system with two-body perturbations, for example, each
equivalence class $s\in\S_2$ would consist of all pairs
$\p{p,q}\in\C_N\p{2}$ that are a fixed distance $\abs{p-q}=d_s$ apart,
i.e.~$s=\set{\p{p,q}\in\C_N\p{2}:\abs{p-q}=d_s}$.

For simplicity, we first assume that the $M$-body operator $X_{\m w}$
obeys the same spatial symmetries as $H_0$.  For any equivalence class
$s\in\S_M$, we then define a uniform superposition $\ket{s}$ over all
choices $k\in s$, as well as the projector $\P_\S$ onto the space of
uniform superpositions:
\begin{align}
  \ket{s} \equiv \f1{\sqrt{\abs{s}}} \sum_{k\in s} \ket{k},
  &&
  \P_{\S_M} \equiv \sum_{s\in\S_M} \op{s},
\end{align}
where $\abs{s}$ is the number of elements in $s$.  We then expand the
coefficient vector $\v{\m w}$ in this symmetrized basis:
\begin{align}
  \v{\m w} = \sum_{k\in\C_N\p{M}} w_k \ket{k}
  = \sum_{s\in\S_M} w_s \sqrt{\abs{s}} \ket{s},
\end{align}
where $w_s\equiv w_k$ for any $k\in s$.  Finally, we define the
projection of $\hat{\m h}$ onto the symmetric subspace:
\begin{align}
  \hat{\m h}_{\S_M}
  \equiv \P_{\S_M} \hat{\m h} \P_{\S_M}
  = \sum_{s\in\S_M} \ket{s} \sp{
    \sum_{k\in s} \sum_{\substack{p\in\ZZ_N\\p\notin k}} \sum_{a\in\ZZ_M}
    \f{h_{p k_a}}{\sqrt{\abs{s}\abs{\sp{k_{a:p}}}}} \bra{\sp{k_{a:p}}}
    - \tilde h_s \bra{s}},
\end{align}
where $\tilde h_s\equiv \tilde h_k$ for any $k\in s$; $k_a$ is the
$a$-th element of $k$;
$k_{a:p}\equiv\p{k_1,k_2,\cdots,k_{a-1},p,k_{a+1},\cdots,k_M}$ is $k$,
but with the $a$-th number $k_a$ replaced by $p$; and $\sp{k_{a:p}}$
is the equivalence class of $k_{a:p}$.  The reduced multi-body
eigenvalue problem is then
\begin{align}
  \hat{\m h}_{\S_M} \c \v{\m w} = \Delta \v{\m w}.
\end{align}
More generally, even if the couplings $\v{\m w}$ of $X_{\m w}$ do not
obey the spatial symmetries as $H_0$, these symmetries generally endow
$\hat{\m h}$ with a block-diagonal structure. \red{[TODO: finish
  discussion/derivation]}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Projecting products of multi-body operators onto the
  permutationally symmetric manifold}
\label{sec:operator_product}

\red{[TODO: write introductory text for this section]}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The general case: a diagrammatic expansion}

Given a system of $N$ spins, we wish to project a product of
multi-body operators onto the permutationally symmetric manifold
$\M_0$.  For $p$ multi-body operators, the projection of such a
product takes the form
\begin{align}
  \P_0 \sp{\prod_{j\in\ZZ_p}
    \sum_{k\in\C_N\p{M_j}} w_j\p{k} X_j\p{k}} \P_0,
  \label{eq:sym_prod_proj}
\end{align}
where $\P_0$ is a projector onto the PS manifold $\M_0$; $j$ indexes
one of the $p$ multi-body operators; $X_j$ is an $M_j$-spin operator
that is invariant under arbitrary permutation of its tensor factors;
$k\in\C_N\p{M_j}$ is a choice of $M_j$ spins that $X_j\p{k}$ acts on;
$\C_N\p{M_j}$ is the set of all choices of $M_j$ elements from a set
of size $N$; and $\m w_j$ are dimension-$M_j$ tensors with scalar
entries $w_j\p{k}$. \red{[TODO: relax the restrictions on $X_j$ and
  $\m w_j$ to allow for more general perturbations, e.g.~of the form
  $s_\x\otimes s_\y-s_\y\otimes s_\x$]}

To simplify the product in \eqref{eq:sym_prod_proj}, we first write
\begin{align}
  \prod_{j\in\ZZ_p} \sum_{k\in\C_N\p{M_j}} w_j\p{k} X_j\p{k}
  = \prod_{j\in\ZZ_p} \f1{M_j!} \sum_{k\in\ZZ_N^{M_j}}
  w_j\p{k} X_j\p{k},
  \label{eq:sym_prod_vec}
\end{align}
where we extend the definitions of $w_j\p{k}$ and $X_j\p{k}$ to all
vectors $k\in\ZZ_N^{M_j}$ by enforcing that these objects are
symmetric with respect to permutations of the entries in $k$, and that
$w_j\p{k}=X_j\p{k}=0$ if $k$ contains any repeated entries.  We then
collect terms whose operator content is equivalent up to a permutation
of spins.  To this end, we classify terms in \eqref{eq:sym_prod_vec}
by the numbers $g_S$ of indices shared by all tensors $w_j$ with
$j\in S\subset\ZZ_p$.  For example, a term of the form
$w_1\p{a,b,c} w_2\p{b,d,e} w_3\p{b,c,d,e}$ with distinct indices
$\p{a,b,c,d,e}\in\C_N\p{5}$ would have
\begin{align}
  g_{\set{1}} = 1,
  &&
  g_{\set{1,2,3}} = 1,
  &&
  g_{\set{1,3}} = 1,
  &&
  g_{\set{2,3}} = 2,
\end{align}
and $g_S=0$ for all other subsets $S\subset\ZZ_3$.  This index
assignment can be represented by the Venn diagram
\begin{align}
  \diagram{example_123},
  \label{eq:venn_diagram}
\end{align}
where $g_S$ is determined the number of dots at the intersection of
circles $\set{w_j:j\in S}$.  Denoting the set of all nonempty subsets
of $\ZZ_p$ by $\PP^*\p{\ZZ_p}$, we denote an assignment of distinct
indices according to choices of $g_S$ for all $S\in\PP^*\p{\ZZ_p}$ by
$g$.  Given a vector $\m M$ of the dimensions $M_j$, we then denote
the set of all valid index assignments $g$ by $\G\p{\m M}$.  For
consistency, all valid index assignments $g\in\G\p{\m M}$ must assign
exactly $M_j$ indices to the dimension-$M_j$ tensor $w_j$, i.e.~
\begin{align}
  \sum_{S\in\PP^*\p{\ZZ_p}\,:\,j\in S} g_S
  = \sum_{R\in\PP^*\p{\ZZ_p\setminus\set{j}}} g_{\set{j}\cup R}
  = M_j
\end{align}
for all $j\in\ZZ_p$.  The set of valid index assignments $\G\p{\m M}$
is then essentially the set of all Venn diagrams of the form in
\eqref{eq:venn_diagram} with $p=\dim\p{\m M}$ circles and a total of
$M_j$ dots within circle $w_j$.

A classification of terms in \eqref{eq:sym_prod_vec} by index
assignments $g\in\G\p{\m M}$ allows us to expand
\begin{align}
  \prod_{j\in\ZZ_p} \sum_{k\in\ZZ_N^{M_j}} w_j\p{k} X_j\p{k}
  \EQPS \sum_{g\in\G\p{\m M}} \S\p{g} w\p{g} X\p{g},
  \label{eq:sym_prod_group_start}
\end{align}
where $\EQPS$ denotes equality up to a restriction to the
permutationally symmetric manifold; $X\p{g}$ is an operator acquired
by assigning indices (choices of spins) to all $X_j$ in a manner
consistent with $g$; $w\p{g}$ is a scalar acquired by summing over all
indices assigned to the tensors $w_j$ according to $g$; and $\S\p{g}$
is a symmetry factor accounting for the number of ways to assign
indices according to $g$.

In order to write out the factors in \eqref{eq:sym_prod_group_start}
explicitly, we identify the set of values that the distinct indices
assigned according to $g$ can take:
\begin{align}
  \C_N\p{g}
  \equiv \set{ k \in \bigotimes_{S\in\PP^*\p{\ZZ_p}} \C_N\p{g_S}
    : \t{all elements of $k$ are distinct} },
  \label{eq:index_values}
\end{align}
where each $k\in\C_N\p{g}$ has the natural decomposition
$k=\p{k_S:S\in\PP^*\p{\ZZ_p}}$ with $k_S\in\C_N\p{g_S}$.  In words,
$\C_N\p{g}$ consists of all the ways to choose, for each subset $S$ of
the tensors $\set{w_j}$, a set $k_S$ of $g_S$ distinct spins, with the
restriction that all $k_S$ are orthogonal: if $z\in k_S$, then
$z\notin k_R$ for $R\ne S$.  Having defined the set $\C_N\p{g}$ of
index values, we define the restriction of $k\in\C_N\p{g}$ to values
associated with $w_j$ and $X_j$:
\begin{align}
  k_j \equiv \bigcup_{S\in\PP^*\p{\ZZ_p} : j\in S} k_S
  = \bigcup_{R\in\PP^*\p{\ZZ_p\setminus\set{j}}} k_{\set{j}\cup R},
\end{align}
where the union of lists $k_S$ denotes a concatenation of those lists.
These definitions allow us to expand
\begin{align}
  w\p{g} \equiv \sum_{k\in\C_N\p{g}} \prod_{j\in\ZZ_p} w_j\p{k_j},
  &&
  X\p{g} \equiv \prod_{j\in\ZZ_p}
  X_j\p{\ell_j}~\t{for some}~\ell\in\C_N\p{g},
  \label{eq:diagram_factors}
\end{align}
where the choice of $\ell\in\C_N\p{g}$ does not matter after
projection onto permutationally symmetric manifold.  Finally, we can
work out that
\begin{align}
  \S\p{g} \equiv \sp{\prod_{j\in\ZZ_p} \C\p{ g_S : j\in S }}
  \sp{\prod_{S\in\PP^*\p{\ZZ_p}} \p{g_S!}^\abs{S}}
  = \prod_{j\in\ZZ_p} M_j!,
  \label{eq:sym_prod_symmetry}
\end{align}
where the first product in \eqref{eq:sym_prod_symmetry} contains
multinomial coefficients
\begin{align}
  \C\p{a_1,a_2,\cdots,a_m}
  \equiv \f{\p{a_1+a_2+\cdots+a_m}!}{a_1!a_2!\cdots a_m!}
\end{align}
that account for the number of ways to partition the indices of each
$w_j$ into sets of shared indices as specified by $g$, and the second
product in \eqref{eq:sym_prod_symmetry} accounts for the number of
ways to permute each set of shared indices on every tensor.
Altogether, the symmetry factors $\S\p{g}$ cancel out with the
$\sim M_j!$ prefactors in \eqref{eq:sym_prod_vec}, so
\begin{align}
  \prod_{j\in\ZZ_p} \sum_{k\in\C_N\p{M_j}} w_j\p{k} X_j\p{k}
  \EQPS \sum_{g\in\G\p{\m M}} w\p{g} X\p{g}.
  \label{eq:sym_prod_group}
\end{align}
This result essentially gives us a diagrammatic expansion for the
product of multi-body operators, projected onto the permutationally
symmetric manifold.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Formalizing diagrams and reducing computational costs}
\label{sec:diagrams}

Diagrams such as \eqref{eq:venn_diagram} will play a major role in the
calculations in this section.  Here, we define these diagrams as
formal objects that we can use in mathematical expressions, enabling
us to systematically perform calculations that are otherwise
intractable.  We then derive rules to ``simplify'' these diagrams in
such a way as to reduce the computational cost of their numerical
evaluation.

The simplest diagrams have $g_S$ filled dots (``$\bullet$'') at the
intersection of the circles $j\in S$, and are simply equal to the
associated scalar $w\p{g}$ defined in \eqref{eq:diagram_factors}, e.g.
\begin{align}
  \diagram{example_123}
  \equiv \sum_{\substack{a,b,c,\in\ZZ_N\\\p{d,e}\in\C_N\p{2}\\
      \abs{\set{a,b,c,d,e}}=5}}
  w_1\p{a,b,c} w_2\p{b,d,e} w_3\p{b,c,d,e},
\end{align}
where the restriction $\abs{\set{a,b,c,d,e}}=5$ denotes that all of
$a,b,c,d,e$ are distinct.  Such a diagram with $\abs{g}$ dots
nominally takes $O\p{N^{\abs{g}}}$ time to compute.  In practice, this
computational cost can be prohibitive for performing numerical
simulations of systems with any appreciable size.  We therefore wish
to simplify diagrams in order to reduce their computational cost as
much as possible.  Our general strategy will be to replace constrained
sums that make all indices interdependent by unconstrained sums that
can be carried out independently, in sequence.  In order to represent
different constraints, we need to define diagrams in which filled dots
(``$\bullet$'') may be replaced by empty dots (``$\circ$'') or crosses
(``$\bm\times$'').

If a region of a diagram contains $F$ filled dots, those dots
correspond to indices that sum over $\C_N\p{F}$ with the constraint
that they are not equal to any other filled dots in a diagram.  $E$
empty dots in a region, meanwhile, correspond to indices that are
summed over $\C_N\p{E}$ without any additional constraints, e.g.
\begin{align}
  \diagram{example_o}
  \equiv \sum_{\substack{\p{a,b}\in\C_N\p{2}\\e\in\ZZ_N\\
      \abs{\set{a,b,e}}=3}}
  \sum_{\substack{\p{c,d}\in\C_N\p{2}\\f\in\ZZ_N}}
  v\p{a,b,c,d,e} w\p{e,f}.
\end{align}
Empty dots are therefore entirely independent of filled dots.
Crosses, meanwhile, are {\it entirely dependent} on filled dots:
``cross indices'' are summed {\it only} over the values of ``filled
dot indices'', e.g.
\begin{align}
  \diagram{example_x}
  \equiv \sum_{\substack{a,e\in\ZZ_N\\\abs{\set{a,e}}=2}}
  \sum_{b,c\in\set{a,e}} \sum_{d\in\ZZ_N}
  u\p{a,b,c} v\p{b,d,e} w\p{b,c,e}.
\end{align}
Empty dots and crosses allow us to decompose diagrams with a high
computational cost into different diagrams with a lower computational
cost.  We will essentially use two tricks to decompose diagrams:
eliminating filled dots (which will add empty dots and crosses), and
eliminating crosses (which will move around filled dots).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Decomposing diagrams}

Given a diagram containing only dots (filled or empty), we can
decompose any filled dot into an empty dot and a cross.  For example,
\begin{align}
  \diagram{example_elim}
  = \diagram{example_elim_o}
  - \diagram{example_elim_x}
  \label{eq:example_elim}
\end{align}
where
\begin{align}
  \diagram{example_elim}
  \equiv \sum_{\substack{a,b,c\in\ZZ_N\\\abs{\set{a,b,c}}=3}}
  v\p{a,b} w\p{b,c},
\end{align}
\begin{align}
  \diagram{example_elim_o}
  \equiv \sum_{\substack{b,c\in\ZZ_N\\\abs{\set{b,c}}=2}}
  v\p{\circ,b} w\p{b,c},
  &&
  v\p{\circ,b} \equiv \sum_{a\in\ZZ_N} v\p{a,b},
  \label{eq:example_elim_o}
\end{align}
\begin{align}
  \diagram{example_elim_x}
  \equiv \sum_{\substack{b,c\in\ZZ_N\\\abs{\set{b,c}}=2}}
  \sum_{a\in\set{b,c}} v\p{a,b} w\p{b,c}.
\end{align}
The decomposition in \eqref{eq:example_elim} essentially breaks up a
sum over $a\in\ZZ_N\setminus\set{b,c}$ into a difference of sums over
$a\in\ZZ_N$ and $a\in\set{b,c}$.  The sum over $a\in\ZZ_N$ to compute
$v\p{\circ,b}$ has $O\p{N^2}$ cost, and can be performed prior to
evaluating the diagram in \eqref{eq:example_elim_o}.  The
decomposition in \eqref{eq:example_elim} therefore splits one
$O\p{N^3}$ diagram into two $O\p{N^2}$ diagrams.

After decomposing a filled dot into an empty dot and a cross, the next
step is to immediately eliminate the cross.  To eliminate a cross from
a diagram, we first note that the corresponding index can ignore other
indices on tensors that contain the index; that is (pay attention to
the sum over $a$),
\begin{align}
  \diagram{example_elim_x}
  \equiv \sum_{\substack{b,c\in\ZZ_N\\\abs{\set{b,c}}=2}}
  \sum_{a\in\set{b,c}} v\p{a,b} w\p{b,c}
  = \sum_{\substack{b,c\in\ZZ_N\\\abs{\set{b,c}}=2}}
  \sum_{a\in\set{c}} v\p{a,b} w\p{b,c}.
\end{align}
For each remaining index addressed by a cross, meanwhile, the cross
simply forces the corresponding indices to be equal, which is
equivalent to moving a filled dot into a different region:
\begin{align}
  \diagram{example_elim_x}
  = 2 \diagram{example_elim_x_full}
  = 2 \sum_{\p{b,c}\in\C_N\p{2}} v\p{c,b} w\p{b,c}.
  \label{eq:example_elim_final}
\end{align}
The factor of 2 accounts for the fact that the left diagram sums over
$b,c\in\ZZ_N$, while the right diagram sums over
$\p{b,c}\in\C_N\p{2}$.  We can generally repeat the above process of
eliminating filled dots and crosses until only empty dots remain in a
diagram.  The only complication in carrying out this process is that
we have to manually keep track of symmetry factors at each step, such
as the factor of 2 in \eqref{eq:example_elim_final}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Symmetry factors}
\label{sec:symmertry_factors}

As seen in \eqref{eq:example_elim_final}, the process of simplifying
diagrams generally involves symmetry factors that need to be kept
track of by hand.  Here we discuss the rules governing symmetry
factors that appear when decomposing diagrams.  In general,
eliminating a filled dot from a region with $F$ filled dots makes a
diagram pick up a factor of $1/F$, e.g.
\begin{align}
  \diagram{example_sym}
  = \f14 \diagram{example_sym_o}
  - \f14 \diagram{example_sym_x}.
\end{align}
This factor can be derived by replacing the sum over $\C_N\p{F}$ for
the filled dots within the region by a sum over $\ZZ_N^{F}$, which
picks up a factor of $1/F!$ to account for the number of ways to
permute $F$ values.  Setting aside one filled dot for replacement by
an empty dot and a cross, the sum over $\ZZ_N^{F-1}$ for the remaining
dots can be changed back to a sum over $\C_N\p{F-1}$, picking up a
factor of $\p{F-1}!$.  The overall factor picked up throughout this
procedure is therefore $\p{F-1}!/F!=1/F$.  Similarly, adding an empty
dot to a region with $E$ empty dots makes the diagram pick up a factor
of $\p{E+1}!/E!=E+1$, so
\begin{align}
  \diagram{example_sym_o}
  = \f23 \diagram{example_sym_oo}
  - \f13 \diagram{example_sym_ox}.
\end{align}
Finally, eliminating a cross by moving a filled dot from an ``old''
region with $F_{\t{old}}$ filled dots into a ``new'' region with
$F_{\t{new}}$ filled dots picks up an overall factor of
$F_{\t{new}}+1$, so
\begin{align}
  \diagram{example_sym_x}
  = 2 \diagram{example_sym_x_elim},
\end{align}
where the factor of $1/F_{\t{old}}$ that is acquired due to removing a
dot from the old region is canceled out by a factor of $F_{\t{old}}$
that accounts for the number of ways to move a dot from the old region
to the new one.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Matrix elements of individual multi-spin operators}

The process of constructing and simplifying diagrams to compute the
coefficients $w\p{g}$ of the diagrammatic operator product expansion
in \eqref{eq:sym_prod_group} is systematic enough to be converted into
an algorithm for execution on a computer.  The last step necessary to
automate the evaluation of \eqref{eq:sym_prod_group} is expansion of
the multi-spin operators $X\p{g}$ in a basis for the permutationally
symmetric manifold $\M_0$.  Without loss of generality, we consider a
single permutationally symmetric $M$-spin operator $X$; our task is
essentially to find coefficients of the expansion
\begin{align}
  \P_0 X \P_0
  = \sum_{a,b\in\B_0} \bk{a|X|b} \op{a}{b},
\end{align}
where $\set{\ket{a}:a\in\B_0}$ is complete bases for $\M_0$, and the
choice of $M$ spins on which $X$ acts is arbitrary.  In a system of
$N$ spins with $n$ states each, a suitable basis for $\M_0$ can be
labeled by the occupation number of each single-spin state, namely
$a=\p{a_1,a_2,\cdots,a_n}$ with each $a_\mu\ge 0$ and
$\sum_\mu a_\mu=N$.  Written out explicitly,
\begin{align}
  \ket{a} = \f1{\sqrt{\C\p{a}}}
  \sum_{\substack{\t{distinct}\\\t{permutations}\\\Pi~\t{of}~\tilde a}}
  \Pi \ket{\tilde a},
  &&
  \ket{\tilde a} \equiv \bigotimes_\mu \ket{\mu}^{\otimes a_\mu},
  &&
  \C\p{a} \equiv \f{\p{\sum_\mu a_\mu}!}{\prod_\mu a_\mu!},
\end{align}
where the multinomial coefficient $\C\p{a}$ counts the number of
distinct ways to permute the tensor factors of $\ket{\tilde a}$, and
enforces $\bk{a|a}=1$.  We denote the set of all valid assignments of
$N$ (identical) spins to $n$ (distinguishable) states by $\A_n\p{N}$,
such that the basis $\set{\ket{a}:a\in\A_n\p{N}}$ spans
permutationally symmetric manifold of $N$ spins.  Identifying this
basis allows us to expand
\begin{align}
  \bk{a|X|b}
  = \sum_{\substack{\alpha,\beta\in\A_n\p{M}\\\alpha\le a,\,\beta\le b}}
  \delta_{a-\alpha,b-\beta}
  \sqrt{\f{\C\p{\alpha}\C\p{a-\alpha}\C\p{\beta}\C\p{b-\beta}}
    {\C\p{a}\C\p{b}}}
  \bk{\alpha|X|\beta},
  \label{eq:multi_body_eval}
\end{align}
where the restriction $\alpha\le a$ and difference $a-\alpha$ are
evaluated element-wise, i.e.~$\alpha<a\implies \alpha_\mu\le a_\mu$
and $\p{a-\alpha}_\mu=a_\mu-\alpha_\mu$ for all $\mu$; and
$\delta_{cd}=1$ if $c=d$ and zero otherwise.  We sum over both
$\alpha$ and $\beta$ above merely to keep the expression symmetric
with respect to transposition; in practice, one can simply sum over
$\alpha\in\A_n\p{M}$ and set $\beta=b-a+\alpha$.  Note that, by slight
abuse of notation, the operator $X$ on the left of
\eqref{eq:multi_body_eval} acts on an arbitrary choice of $M$ spins
(out of $N$), whereas the operator $X$ on the right of
\eqref{eq:multi_body_eval} is simply an $M$-spin operator, with matrix
elements $\bk{\alpha|X|\beta}$ evaluated with respect to the $M$-spin
states $\ket\alpha,\ket\beta$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Two single-body operators}
\label{sec:single_pair_prod}

Here we simplify the single-body product
\begin{align}
  \P_0 X_{\m v} Y_{\m w} \P_0
  = \P_0 \sp{\sum_{p,q\in\ZZ_N} v_p w_q X_p Y_q} \P_0
  \EQPS \diagram{single_body_0} X_1 Y_2
  + \diagram{single_body_1} X_1 Y_1,
\end{align}
where $\P_0$ is a projector onto the permutationally symmetric
manifold $\M_0$; $p,q$ index individual spins; $v_p,w_p$ are scalars;
and $X,Y$ are single-spin operators.  This product appears, for
example, in the calculation of the second-order effective Hamiltonian
$H_1^{(2)}$ induced on the permutationally symmetric manifold $\M_0$
by a single-body perturbation.  Defining
\begin{align}
  \v{\m m} \equiv \sum_{p\in\ZZ_N} m_p \ket{p},
  &&
  \col{m} \equiv \sum_{p\in\ZZ_N} m_p,
\end{align}
for both $\m m\in\set{\m v,\m w}$, we can simplify
\begin{align}
  \diagram{single_body_1} = \v{\m v}\c\v{\m w},
\end{align}
and
\begin{align}
  \diagram{single_body_0}
  = \diagram{single_body_0_o} - \diagram{single_body_0_x}
  = \diagram{single_body_0_oo} - \diagram{single_body_1}
  = \col{v}\,\col{w} - \v{\m v} \c\v{\m w},
\end{align}
so
\begin{align}
  \sum_{p,q\in\ZZ_N} v_p w_q X_p Y_q
  \EQPS \col{v}\,\col{w} X_1 Y_2
  - \v{\m v}\c\v{\m w} \p{X_1 Y_2 - X_1 Y_1},
\end{align}
In order to write this result in terms of collective operators
$\col{Z} \equiv \sum_{p\in\ZZ_N} Z_p$, we expand
\begin{align}
  \col{X Y} \EQPS N X_1 Y_1,
  &&
  \col{X}\,\col{Y} \EQPS \col{XY} + N\p{N-1} X_1 Y_2,
\end{align}
which implies that
\begin{align}
  \sum_{p,q\in\ZZ_N} v_p w_q X_p Y_q
  \EQPS \f{\col{v}\,\col{w}}{N\p{N-1}}
  \p{\col{X}\,\col{Y} - \col{XY}}
  - \f{\v{\m v}\c\v{\m w}}{N\p{N-1}}
  \p{\col{X}\,\col{Y} - N\col{XY}}.
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Two two-body operators}
\label{sec:two_pair_prod}

Here we simplify the two-body product
\begin{multline}
  \P_0 X_{\m v} Y_{\m w} \P_0
  = \P_0 \sp{\sum_{\p{k,\ell},\p{p,q}\in\C_N\p{2}}
    v_{k\ell} w_{pq} X_{k\ell} Y_{pq}} \P_0 \\
  \EQPS \diagram{two_body_0} X_{1,2} Y_{3,4}
  + \diagram{two_body_1} X_{1,2} Y_{1,3}
  + \diagram{two_body_2} X_{1,2} Y_{1,2},
\end{multline}
where $\P_0$ is a projector onto the permutationally symmetric
manifold $\M_0$; $k,\ell,p,q$ index individual spins;
$v_{k\ell},w_{pq}$ are scalar coefficients with $m_{pq}=m_{qp}$ and
$m_{pp}=0$ for both $\m m\in\set{\m v,\m w}$; and $X,Y$ are
permutationally symmetric two-spin operators.  This product appears,
for example, in the calculation of the second-order effective
Hamiltonian $H_2^{(2)}$ induced on the permutationally symmetric
manifold $\M_0$ by a two-body perturbation.  Defining
\begin{align}
  \v{\m m} \equiv \sum_{\p{p,q}\in\C_N\p{2}} m_{pq} \ket{\set{p,q}},
  &&
  \v m \equiv \sum_{p,q\in\ZZ_N} m_{pq} \ket{p},
  &&
  \col{m} \equiv \sum_{\p{p,q}\in\C_N\p{2}} m_{pq},
\end{align}
for both $\m m\in\set{\m v,\m w}$, we can write
\begin{align}
  \diagram{two_body_2} = \v{\m v} \c\v{\m w},
\end{align}
and simplify
\begin{align}
  \diagram{two_body_1}
  &= \sp{\diagram{two_body_1_o}} - \sp{\diagram{two_body_1_x}} \\
  &= \sp{\diagram{two_body_1_oo} - \diagram{two_body_1_ox}}
  - \sp{2\diagram{two_body_2}} \label{eq:mid_zero} \\
  &= \v v \c \v w - 2 \v{\m v} \c \v{\m w},
\end{align}
where the middle diagram in \eqref{eq:mid_zero} contains an empty sum
for the cross, and is therefore equal to zero.  Finally, with a bit of
more work (or a computer) we can work out that
\begin{align}
  \diagram{two_body_0}
  = \diagram{two_body_0_oooo} - \diagram{two_body_1_ooo}
  + \diagram{two_body_2_oo}
  = \col{v}\,\col{w} -\v v\c\v w + \v{\m v}\c\v{\m w}.
\end{align}
Altogether,
\begin{align}
  X_{\m v} Y_{\m w}
  \EQPS \p{\col{v}\,\col{w} -\v v\c\v w + \v{\m v}\c\v{\m w}}
  X_{1,2} Y_{3,4}
  + \p{\v v\c\v w - 2 \v{\m v} \c \v{\m w}} X_{1,2} Y_{1,3}
  + \v{\m v} \c \v{\m w}\, X_{1,2} Y_{1,2}.
\end{align}
In the special case that $X=Y=Z\otimes Z$ with a single-spin operator
$Z$ for which $Z^2=1$, we can further simplify
\begin{align}
  \sum_{\p{k,\ell},\p{p,q}\in\C_N\p{2}} v_{k\ell} w_{pq}
  Z_k Z_\ell Z_p Z_q
  \EQPS \p{\col{v}\,\col{w} -\v v\c\v w + \v{\m v}\c\v{\m w}}
  Z^{\otimes 4}
  + \p{\v v\c\v w - 2 \v{\m v} \c \v{\m w}} Z^{\otimes 2}
  + \v{\m v}\c\v{\m w}.
\end{align}
In terms of collective operators
$\col{Z} \equiv \sum_{p\in\ZZ_N} Z_p$, we then have
\begin{multline}
  \sum_{\p{k,\ell},\p{p,q}\in\C_N\p{2}} v_{k\ell} w_{pq}
  Z_k Z_\ell Z_p Z_q \\
  \EQPS \f{\col{v}\,\col{w} -\v v\c\v w + \v{\m v}\c\v{\m w}}{N!_4}
  \sp{\col{Z}^4 - 2\p{3N-4} \col{Z}^2}
  + \f{\p{\v v\c\v w - 2 \v{\m v} \c \v{\m w}}}{N!_2}\, \col{Z}^2 \\
  + \f{3\,\col{v}\,\col{w} - N \v v\c\v w + N\p{N-2}\v{\m v}\c\v{\m
      w}}{\p{N-1}\p{N-3}},
\end{multline}
where
\begin{align}
  N!_k \equiv \prod_{j=0}^{k-1} \p{N-j} = \f{N!}{\p{N-k}!}
\end{align}
denotes a falling factorial.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Three two-body Ising-like operators}

Here we simplify the product
\begin{align}
  \Z \equiv \P_0 \sp{\sum_{\p{k,\ell},\p{p,q},\p{r,s}\in\C_N\p{2}}
    u_{k\ell} v_{pq} w_{rs} Z_k Z_\ell Z_p Z_q Z_r Z_s} \P_0,
  &&
  Z^2 = 1,
\end{align}
where $\P_0$ is a projector onto the permutationally symmetric
manifold $\M_0$; $k,\ell,p,q,r,s$ index individual spins; $Z$ is a
single-spin operator; and $u_{k\ell},v_{pq},w_{rs}$ are scalar
coefficients with $m_{pq}=m_{qp}$ and $m_{pp}=0$ for each of
$\m m\in\set{\m u,\m v,\m w}$.  \red{[TODO: give example of when this
  product appears.]} Collecting terms according to the number of $Z$
operators that remain after accounting for $Z^2=1$, we find that
\begin{align}
  \Z \EQPS A_6 Z^{\otimes 6} + A_4 Z^{\otimes 4}
  + A_2 Z^{\otimes 2} + A_0,
  \label{eq:triple_multi}
\end{align}
with
\begin{align}
  A_6 \equiv \diagram{triple_0},
  &&
  A_4 \equiv \diagram{triple_01} + \diagram{triple_1},
  &&
  A_0 \equiv \diagram{triple_0111},
  \label{eq:triple_64}
\end{align}
\begin{align}
  A_2 \equiv \diagram{triple_011} + \diagram{triple_02}
  + \diagram{triple_11} + \diagram{triple_2},
  \label{eq:triple_2}
\end{align}
where a diagram with unlabeled circles denotes a sum over all distinct
label assignments, e.g.
\begin{align}
  \diagram{triple_1} \equiv \diagram{triple_1_uvw},
  \label{eq:triple_uvw}
\end{align}
\begin{align}
  \diagram{triple_011}
  \equiv \diagram{triple_011_uvw}
  + \diagram{triple_011_vwu} + \diagram{triple_011_wuv}.
  \label{eq:triple_uvw_3}
\end{align}
The last diagram in each of $A_6,A_4,A_2,A_0$ as written in
\eqref{eq:triple_64}, \eqref{eq:triple_2} thus has only one assignment
of labels, as in \eqref{eq:triple_uvw}, while all other unlabeled
diagrams have three assignments, as in \eqref{eq:triple_uvw_3}.

Having identified diagrammatic representations of the coefficients
$A_6,A_4,A_2,A_0$, we now need to simplify all diagrams to reduce
their computational complexity, as discussed in Appendix
\ref{sec:diagrams}.  The process of eliminating filled dots and
crosses from a diagram is algorithmic enough to execute on a computer,
doing which we find
\begin{align}
  A_6 = D_6 - D_4 + D_2 - D_0,
  &&
  A_4 = D_4 - 2 D_2 + 3 D_0,
  &&
  A_2 = D_2 - 3 D_0,
  &&
  A_0 \equiv D_0,
\end{align}
where
\begin{align}
  D_6 \equiv \diagram{triple_0_o},
  &&
  D_4 \equiv \diagram{triple_01_o} - 2 \diagram{triple_1_o},
  &&
  D_0 \equiv \diagram{triple_0111_o},
\end{align}
\begin{align}
  D_2 \equiv \diagram{triple_011_o}
  + \diagram{triple_02_o}
  - 2 \diagram{triple_11_o}
  + 4 \diagram{triple_2_o}.
\end{align}
Defining, for each of $\m m\in\set{\m u,\m v,\m w}$,
\begin{align}
  \v{\m m} \equiv \sum_{\p{p,q}\in\C_N\p{2}} m_{pq} \ket{\set{p,q}},
  &&
  \v m \equiv \sum_{p\in\ZZ_N} m_p \ket{p},
  &&
  m_p \equiv \sum_{q\in\ZZ_N} m_{pq},
  &&
  \col{m} \equiv \sum_{\p{p,q}\in\C_N\p{2}} m_{pq},
\end{align}
we can expand
\begin{align}
  D_6 = \col{u}\,\col{v}\,\col{w},
  &&
  D_4 = \col{u}\,\v v\c\v w + \col{v}\,\v w\c\v u
  + \col{w}\,\v u\c\v v - 2 \sum_{p\in\ZZ_N} u_p v_p w_p,
  &&
  D_0 = \tr\p{\m u \c \m v \c \m w},
\end{align}
\begin{multline}
  D_2 = \v u \c\m v\c\v w + \v v \c\m w\c\v u + \v w \c\m u\c\v v
  + \col{u}\,\v{\m v}\c\v{\m w} + \col{v}\,\v{\m w}\c\v{\m u}
  + \col{w}\,\v{\m u}\c\v{\m v} \\
  - 2 \sum_{p,q\in\ZZ_N} \p{u_p v_{pq} w_{pq}
    + v_p w_{pq} u_{pq} + w_p u_{pq} v_{pq}}
  + 4 \sum_{\p{p,q}\in\C_N\p{2}} u_{pq} v_{pq} w_{pq}.
\end{multline}
Finally, we can also write the product $\Z$ in \eqref{eq:triple_multi}
in terms of the collective operator
$\col{Z} \equiv \sum_{p\in\ZZ_N} Z_p$:
\begin{align}
  \Z \EQPS
  \tilde A_6 \col{Z}^6 + \tilde A_4 \col{Z}^4
  + \tilde A_2 \col{Z}^2 + \tilde A_0,
  \label{eq:triple_col}
\end{align}
where
\begin{align}
  \tilde A_6 \equiv \f{A_6}{N!_6},
  &&
  \tilde A_4 \equiv \f{A_4}{N!_4} - 5\p{3N-8} \f{A_6}{N!_6},
\end{align}
\begin{align}
  \tilde A_2 \equiv \f{A_2}{N!_2} - 2\p{3N-4} \f{A_4}{N!_4}
  + \p{45N^2-210N+184} \f{A_6}{N!_6},
\end{align}
\begin{align}
  \tilde A_0 \equiv A_0 - \f{A_2}{N-1}
  + \f{3A_4}{\p{N-1}\p{N-3}}
  - \f{15A_6}{\p{N-1}\p{N-3}\p{N-5}}.
\end{align}

\bibliography{\jobname.bib}

\end{document}
